,,,,,
,,THEME,QUESTION,SQL,KEY PURPOSE
,,CTR/CVR,Daily CTR and CVR by campaign.,"SELECT date_trunc('day', i.ts) AS d, i.campaign_id, count() AS impressions, count(c.click_id) AS clicks, count(b.booking_id) AS bookings, 1.0 * count(c.click_id) / count() AS ctr, 1.0 * count(b.booking_id) / NULLIF(count(c.click_id),0) AS cvr FROM ad_impressions i LEFT JOIN ad_clicks c ON c.user_id=i.user_id AND c.campaign_id=i.campaign_id AND c.ts BETWEEN i.ts AND i.ts + INTERVAL '1' day LEFT JOIN bookings b ON b.user_id=i.user_id AND b.ts BETWEEN i.ts AND i.ts + INTERVAL '7' day GROUP BY 1,2","Conditional joins, NULLIF"
,,ROAS,ROAS by channel per day.,"SELECT s.dt, s.channel, sum(s.spend) AS spend, sum(b.rev) AS revenue, 1.0*sum(b.rev)/NULLIF(sum(s.spend),0) AS roas FROM channel_spend s LEFT JOIN ( SELECT date_trunc('day', b.ts) AS dt, sess.channel, sum(b.payout) AS rev FROM bookings b JOIN sessions sess ON b.session_id=sess.session_id GROUP BY 1,2 ) b ON s.dt=b.dt AND s.channel=b.channel GROUP BY 1,2",Spend join to booked revenue
,,Last-touch,Last channel before booking (per booking).,"SELECT b.booking_id, max_by(sess.channel, sess.start_ts) AS last_touch FROM bookings b JOIN sessions sess ON b.user_id=sess.user_id AND sess.start_ts <= b.ts GROUP BY 1","max_by(val, sort_by)"
,,LTV 90d,90-day LTV by signup cohort month.,"WITH u AS ( SELECT user_id, date_trunc('month', signup_ts) AS cohort FROM users ), r AS ( SELECT u.cohort, b.user_id, sum(b.payout) AS rev FROM u JOIN bookings b ON u.user_id=b.user_id AND b.ts <= u.cohort + INTERVAL '90' day GROUP BY 1,2 ) SELECT cohort, count(DISTINCT user_id) AS users, 1.0*sum(rev)/NULLIF(count(DISTINCT user_id),0) AS ltv_90d FROM r GROUP BY 1 ORDER BY 1",Cohorts + horizon
,,Funnel,Session-level funnel rates (view→checkout→book).,"WITH step AS ( SELECT e.session_id, max(CASE WHEN event='view' THEN 1 END) AS v, max(CASE WHEN event='start_checkout' THEN 1 END) AS sc, max(CASE WHEN event='book' THEN 1 END) AS bk FROM events e GROUP BY 1 ) SELECT count() AS sessions, 1.0sum(v)/count() AS p_view, 1.0sum(sc)/NULLIF(sum(v),0) AS p_sc_given_view, 1.0*sum(bk)/NULLIF(sum(sc),0) AS p_book_given_sc FROM step",Binary step flags
,,Rolling,7-day rolling bookings per channel.,"SELECT date_trunc('day', b.ts) AS d, s.channel, sum(b.payout) AS rev, sum(sum(b.payout)) OVER (PARTITION BY s.channel ORDER BY date_trunc('day', b.ts) ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS rev_7d FROM bookings b JOIN sessions s ON b.session_id=s.session_id GROUP BY 1,2",Window with frame
,,Retention,Month-N retention from signup.,"WITH a AS ( SELECT user_id, date_trunc('month', signup_ts) AS cohort FROM users ), m AS ( SELECT DISTINCT e.user_id, date_trunc('month', e.ts) AS active_m FROM events e ) SELECT cohort, month_diff(cohort, active_m) AS m_n, count(DISTINCT m.user_id) AS active_users FROM a JOIN m ON a.user_id=m.user_id GROUP BY 1,2 ORDER BY 1,2",month_diff helper
,,A/B mean,A/B diff in booking rate with stats.,"WITH base AS ( SELECT t.variant, count() AS users, count_if(b.booking_id IS NOT NULL) AS booked FROM ( SELECT user_id, variant FROM experiment_assignments ) t LEFT JOIN bookings b ON b.user_id=t.user_id GROUP BY 1 ), stats AS ( SELECT * , 1.0booked/users AS cr FROM base ) SELECT sA.cr AS cr_A, sB.cr AS cr_B, (sB.cr - sA.cr) AS diff, ( sA.cr*(1-sA.cr)/sA.users + sB.cr*(1-sB.cr)/sB.users ) AS var, (sB.cr - sA.cr)/sqrt(var) AS z FROM stats sA CROSS JOIN stats sB WHERE sA.variant='A' AND sB.variant='B'","count_if, z-score"
,,CUPED,CUPED-style adjusted mean for A/B.,"WITH d AS ( SELECT t.variant, u.user_id, COALESCE(pre.pre_rev,0.0) AS x, COALESCE(post.post_rev,0.0) AS y FROM experiment_assignments t JOIN users u ON t.user_id=u.user_id LEFT JOIN ( SELECT user_id, sum(payout) AS pre_rev FROM bookings WHERE ts < date '2025-01-01' GROUP BY 1 ) pre USING (user_id) LEFT JOIN ( SELECT user_id, sum(payout) AS post_rev FROM bookings WHERE ts >= date '2025-01-01' GROUP BY 1 ) post USING (user_id) ), theta AS ( SELECT covar_samp(y,x)/NULLIF(var_samp(x),0) AS th FROM d ) SELECT variant, avg(y - th*(x - avg(x) OVER())) AS cuped_mean FROM d CROSS JOIN theta GROUP BY 1","covar_samp, var_samp, CUPED"
,,DiD,Geo DiD on bookings before/after launch.,"WITH g AS ( SELECT geo, CASE WHEN geo IN ('US_TX','US_FL') THEN 1 ELSE 0 END AS trt FROM sessions GROUP BY 1,2 ), ba AS ( SELECT CASE WHEN b.ts < date '2025-06-01' THEN 0 ELSE 1 END AS post, s.geo, count(*) AS books FROM bookings b JOIN sessions s ON b.session_id=s.session_id GROUP BY 1,2 ) SELECT post, trt, sum(books) AS n FROM ba JOIN g USING (geo) GROUP BY 1,2",2x2 cells; DiD computed in tool or add SQL for deltas
,,Sessionize,Build 30-min sessions from events.,"WITH e AS ( SELECT user_id, ts, CASE WHEN lag(ts) OVER (PARTITION BY user_id ORDER BY ts) IS NULL OR date_diff('minute', lag(ts) OVER (PARTITION BY user_id ORDER BY ts), ts) > 30 THEN 1 ELSE 0 END AS new_s FROM events ), s AS ( SELECT user_id, ts, sum(new_s) OVER (PARTITION BY user_id ORDER BY ts) AS sid FROM e ) SELECT * FROM s",Gap-based segmentation
,,MTA simple,Split booking revenue equally across channels observed in 7-day lookback.,"WITH hist AS ( SELECT b.booking_id, b.payout, array_agg(DISTINCT s.channel) FILTER (WHERE s.start_ts BETWEEN b.ts - INTERVAL '7' day AND b.ts) AS chs FROM bookings b JOIN sessions s ON b.user_id=s.user_id GROUP BY 1,2 ), explode AS ( SELECT booking_id, payout, ch, cardinality(chs) AS k FROM hist CROSS JOIN UNNEST(chs) AS t(ch) ) SELECT ch AS channel, sum(payout*1.0/k) AS attrib_rev FROM explode GROUP BY 1","UNNEST, equal split"
,,Percentiles,Time-to-book percentiles.,"WITH t AS ( SELECT b.user_id, min_by(s.start_ts, s.start_ts) AS first_s, min_by(b.ts, b.ts) AS first_b FROM bookings b JOIN sessions s ON b.session_id=s.session_id GROUP BY 1 ) SELECT approx_percentile( date_diff('hour', first_s, first_b), ARRAY[0.5,0.9,0.95] ) AS p50_p90_p95 FROM t",approx_percentile
,,UTM parse,Extract utm params from landing_url.,"SELECT session_id, url_extract_parameter(landing_url,'utm_source') AS utm_source, url_extract_parameter(landing_url,'utm_campaign') AS utm_campaign FROM sessions",Built-ins for URL
,,De-dupe,Pick one device per user by latest seen.,"SELECT user_id, max_by(device, start_ts) AS primary_device FROM sessions GROUP BY 1",max_by again
,,Pivot,Pivot revenue by channel (wide).,"SELECT date_trunc('day', b.ts) AS d, sum(CASE WHEN s.channel='Paid Search' THEN b.payout END) AS paid_search, sum(CASE WHEN s.channel='Paid Social' THEN b.payout END) AS paid_social, sum(CASE WHEN s.channel='Affiliates' THEN b.payout END) AS affiliates FROM bookings b JOIN sessions s ON b.session_id=s.session_id GROUP BY 1 ORDER BY 1",Conditional agg
,,Top paths,Top 10 channel paths within 7 days pre-booking.,"WITH seq AS ( SELECT b.booking_id, array_join( array_agg(s.channel ORDER BY s.start_ts), ' > ') AS path FROM bookings b JOIN sessions s ON b.user_id=s.user_id AND s.start_ts BETWEEN b.ts - INTERVAL '7' day AND b.ts GROUP BY 1 ) SELECT path, count(*) AS n FROM seq GROUP BY 1 ORDER BY n DESC LIMIT 10",array_agg + order
,,Anomaly,Z-score for daily spend by channel.,"WITH x AS ( SELECT dt, channel, spend, avg(spend) OVER (PARTITION BY channel ORDER BY dt ROWS BETWEEN 14 PRECEDING AND CURRENT ROW) AS mu, stddev_samp(spend) OVER (PARTITION BY channel ORDER BY dt ROWS BETWEEN 14 PRECEDING AND CURRENT ROW) AS sd FROM channel_spend ) SELECT dt, channel, spend, (spend-mu)/NULLIF(sd,0) AS z FROM x","Rolling mean, sd"
,,Dedup clicks,First click after impression within 24h.,"SELECT i.impression_id, min_by(c.click_id, c.ts) AS first_click FROM ad_impressions i LEFT JOIN ad_clicks c ON c.user_id=i.user_id AND c.campaign_id=i.campaign_id AND c.ts BETWEEN i.ts AND i.ts + INTERVAL '24' hour GROUP BY 1",min_by with time
,,CPA,CPA by campaign with trims (1st–99th pct).,"WITH conv AS ( SELECT c.campaign_id, c.click_id, min_by(b.booking_id, b.ts) AS first_book, min_by(b.payout, b.ts) AS rev FROM ad_clicks c LEFT JOIN bookings b ON b.user_id=c.user_id AND b.ts BETWEEN c.ts AND c.ts+INTERVAL '7' day GROUP BY 1,2 ), cpa AS ( SELECT campaign_id, CASE WHEN first_book IS NOT NULL THEN 1 END AS conv FROM conv ) , agg AS ( SELECT campaign_id, sum(conv) AS convs FROM cpa GROUP BY 1 ) SELECT s.campaign_id, sum(s.spend)/NULLIF(a.convs,0) AS cpa FROM channel_spend s JOIN agg a ON s.campaign_id=a.campaign_id GROUP BY 1",Trim via horizon + first conversion
,,HLL,Approx unique users per channel.,"SELECT s.channel, approx_distinct(b.user_id) AS users FROM bookings b JOIN sessions s ON b.session_id=s.session_id GROUP BY 1",approx_distinct
,,Cohort ROAS,Signup-month cohort ROAS in 30d.,"WITH c AS ( SELECT user_id, date_trunc('month', signup_ts) AS cohort FROM users ), r AS ( SELECT c.cohort, sum(b.payout) AS rev FROM c JOIN bookings b ON b.user_id=c.user_id AND b.ts <= c.cohort + INTERVAL '30' day GROUP BY 1 ), spend AS ( SELECT date_trunc('month', dt) AS m, sum(spend) AS spend FROM channel_spend GROUP BY 1 ) SELECT r.cohort, r.rev, s.spend, 1.0*r.rev/NULLIF(s.spend,0) AS roas FROM r JOIN spend s ON r.cohort=s.m",Cohort tie to spend month
,,Country mix,Share of revenue by country per week.,"SELECT date_trunc('week', b.ts) AS wk, u.country, sum(b.payout) AS rev, 1.0*sum(b.payout)/sum(sum(b.payout)) OVER (PARTITION BY date_trunc('week', b.ts)) AS share FROM bookings b JOIN users u ON b.user_id=u.user_id GROUP BY 1,2",Share via window
,,Email lift,Open→book conversion within 3 days.,"WITH got_email AS ( SELECT user_id, sent_ts FROM emails ), outcome AS ( SELECT g.user_id, max(CASE WHEN b.ts BETWEEN g.sent_ts AND g.sent_ts+INTERVAL '3' day THEN 1 END) AS booked FROM got_email g LEFT JOIN bookings b ON b.user_id=g.user_id GROUP BY 1 ) SELECT avg(booked) AS conv_rate FROM outcome",Post-exposure window